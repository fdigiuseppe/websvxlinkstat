<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risultati Analisi - SVXLink Log Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .header-section {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 2rem;
            text-align: center;
        }
        .results-section {
            padding: 2rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: none;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .transmission-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3498db;
        }
        .btn-back {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="main-container">
                    <!-- Header -->
                    <div class="header-section">
                        <h1><i class="fas fa-chart-line me-3"></i>Risultati Analisi</h1>
                        <p class="mb-0">File analizzato: <strong>{{ filename }}</strong></p>
                    </div>

                    <!-- Results Section -->
                    <div class="results-section">
                        <!-- Main Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="fas fa-clock text-primary fa-2x mb-2"></i>
                                    <div class="stat-value text-primary">
                                        {{ stats.total_transmission_time.hours }}h {{ stats.total_transmission_time.minutes }}m {{ stats.total_transmission_time.seconds }}s
                                    </div>
                                    <div class="stat-label">Tempo totale trasmissione</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="fas fa-signal text-success fa-2x mb-2"></i>
                                    <div class="stat-value text-success">{{ stats.carriers_opened }}</div>
                                    <div class="stat-label">Portanti aperte</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="fas fa-microphone text-info fa-2x mb-2"></i>
                                    <div class="stat-value text-info">{{ stats.total_transmissions }}</div>
                                    <div class="stat-label">Trasmissioni totali</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card text-center">
                                    <i class="fas fa-comments text-warning fa-2x mb-2"></i>
                                    <div class="stat-value text-warning">{{ stats.qso_analysis.total_qso }}</div>
                                    <div class="stat-label">QSO rilevati</div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Statistics Row -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <i class="fas fa-volume-up text-primary fa-2x mb-2"></i>
                                    <div class="stat-value text-primary">{{ stats.ctcss_tones.unique_tones }}</div>
                                    <div class="stat-label">Subtoni CTCSS</div>
                                    <small class="text-muted">{{ stats.ctcss_tones.total_detections }} rilevamenti</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <i class="fas fa-users text-success fa-2x mb-2"></i>
                                    <div class="stat-value text-success">{{ stats.talk_groups.unique_tgs }}</div>
                                    <div class="stat-label">Talk Groups</div>
                                    <small class="text-muted">{{ stats.talk_groups.total_selections }} selezioni</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card text-center">
                                    <i class="fas fa-stopwatch text-info fa-2x mb-2"></i>
                                    <div class="stat-value text-info">{{ stats.qso_analysis.qso_avg_duration.formatted }}</div>
                                    <div class="stat-label">Durata media QSO</div>
                                    <small class="text-muted">{{ stats.qso_analysis.qso_time.hours }}h {{ stats.qso_analysis.qso_time.minutes }}m tempo totale</small>
                                </div>
                            </div>
                        </div>

                        <!-- CTCSS and TG Analysis -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-volume-up me-2"></i>Subtoni CTCSS Rilevati</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if stats.ctcss_tones.tones_detail %}
                                        <div class="table-container" style="max-height: 300px;">
                                            <table class="table table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Frequenza</th>
                                                        <th class="text-end">Rilevamenti</th>
                                                        <th class="text-end">%</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for tone, count in stats.ctcss_tones.tones_detail %}
                                                    <tr>
                                                        <td><strong>{{ tone }} Hz</strong></td>
                                                        <td class="text-end">
                                                            <span class="badge bg-primary">{{ count }}</span>
                                                        </td>
                                                        <td class="text-end">
                                                            <small class="text-muted">
                                                                {{ "%.1f"|format((count / stats.ctcss_tones.total_detections * 100)) }}%
                                                            </small>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <p class="text-muted text-center mb-0">Nessun subtono CTCSS rilevato</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-users me-2"></i>Talk Groups Utilizzati</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if stats.talk_groups.tgs_detail %}
                                        <div class="table-container" style="max-height: 300px;">
                                            <table class="table table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Talk Group</th>
                                                        <th class="text-end">Selezioni</th>
                                                        <th class="text-end">%</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for tg, count in stats.talk_groups.tgs_detail %}
                                                    <tr>
                                                        <td><strong>TG #{{ tg }}</strong></td>
                                                        <td class="text-end">
                                                            <span class="badge bg-success">{{ count }}</span>
                                                        </td>
                                                        <td class="text-end">
                                                            <small class="text-muted">
                                                                {{ "%.1f"|format((count / stats.talk_groups.total_selections * 100)) }}%
                                                            </small>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <p class="text-muted text-center mb-0">Nessun Talk Group rilevato</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Duration Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-bar me-2"></i>Statistiche Durata</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Durata minima:</strong><br>
                                                <span class="text-success">{{ stats.min_duration.formatted }}</span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Durata massima:</strong><br>
                                                <span class="text-danger">{{ stats.max_duration.formatted }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-pie-chart me-2"></i>Distribuzione Eventi</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="eventsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Events Table -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-list me-2"></i>Dettaglio Eventi</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-container">
                                            <table class="table table-striped table-sm">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Evento</th>
                                                        <th class="text-end">Occorrenze</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for event, count in stats.events.items() %}
                                                    <tr>
                                                        <td>
                                                            {% if 'transmitter' in event %}
                                                                <i class="fas fa-broadcast-tower me-2 text-primary"></i>
                                                            {% elif 'ctcss' in event %}
                                                                <i class="fas fa-volume-up me-2 text-success"></i>
                                                            {% elif 'squelch' in event %}
                                                                <i class="fas fa-microphone me-2 text-info"></i>
                                                            {% elif 'talker' in event %}
                                                                <i class="fas fa-user me-2 text-warning"></i>
                                                            {% elif 'node' in event %}
                                                                <i class="fas fa-network-wired me-2 text-secondary"></i>
                                                            {% else %}
                                                                <i class="fas fa-info-circle me-2 text-muted"></i>
                                                            {% endif %}
                                                            {{ event.replace('_', ' ').title() }}
                                                        </td>
                                                        <td class="text-end"><span class="badge bg-primary">{{ count }}</span></td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- QSO Analysis -->
                        {% if stats.qso_analysis.qso_sessions %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-comments me-2"></i>QSO Rilevati 
                                            <span class="badge bg-primary ms-2">{{ stats.qso_analysis.total_qso }}</span>
                                        </h5>
                                        <small class="text-muted">
                                            Tempo totale QSO: {{ stats.qso_analysis.qso_time.hours }}h {{ stats.qso_analysis.qso_time.minutes }}m {{ stats.qso_analysis.qso_time.seconds }}s
                                            | Durata media: {{ stats.qso_analysis.qso_avg_duration.formatted }}
                                        </small>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-container">
                                            <table class="table table-striped table-sm">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Talk Group</th>
                                                        <th>Inizio</th>
                                                        <th>Fine</th>
                                                        <th class="text-end">Durata</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for qso in stats.qso_analysis.qso_sessions %}
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-info">TG #{{ qso.tg }}</span>
                                                        </td>
                                                        <td>{{ qso.start.strftime('%H:%M:%S') }}</td>
                                                        <td>{{ qso.end.strftime('%H:%M:%S') }}</td>
                                                        <td class="text-end">
                                                            {% set duration_minutes = (qso.duration_seconds // 60)|int %}
                                                            {% set duration_seconds = (qso.duration_seconds % 60)|int %}
                                                            <span class="badge bg-success">{{ duration_minutes }}m {{ duration_seconds }}s</span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- TG Duration Analysis -->
                        {% if stats.talk_groups.tg_durations %}
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-pie me-2"></i>Durata QSO per Talk Group</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="tgDurationChart" style="height: 300px;"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-table me-2"></i>Riepilogo Talk Groups</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-container" style="max-height: 300px;">
                                            <table class="table table-striped table-sm">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Talk Group</th>
                                                        <th class="text-center">QSO</th>
                                                        <th class="text-end">Totale</th>
                                                        <th class="text-end">Media</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for tg, data in stats.talk_groups.tg_durations %}
                                                    <tr>
                                                        <td><strong>TG #{{ tg }}</strong></td>
                                                        <td class="text-center">
                                                            <span class="badge bg-info">{{ data.qso_count }}</span>
                                                        </td>
                                                        <td class="text-end">
                                                            <span class="badge bg-success">{{ data.formatted_total }}</span>
                                                        </td>
                                                        <td class="text-end">
                                                            <span class="badge bg-warning">{{ data.formatted_avg }}</span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% set total_qso_time = stats.qso_analysis.qso_time.total_seconds %}
                                        {% if total_qso_time > 0 %}
                                        <div class="mt-3 p-2 bg-light rounded">
                                            <small class="text-muted">
                                                <strong>Tempo QSO totale:</strong> {{ stats.qso_analysis.qso_time.hours }}h {{ stats.qso_analysis.qso_time.minutes }}m {{ stats.qso_analysis.qso_time.seconds }}s
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Transmissions Timeline -->
                        {% if stats.transmissions %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-history me-2"></i>Ultime Trasmissioni</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-container">
                                            <table class="table table-striped table-sm">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Inizio</th>
                                                        <th>Fine</th>
                                                        <th class="text-end">Durata</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for transmission in stats.transmissions %}
                                                    <tr>
                                                        <td>{{ transmission.start.strftime('%H:%M:%S') }}</td>
                                                        <td>{{ transmission.end.strftime('%H:%M:%S') }}</td>
                                                        <td class="text-end">
                                                            {% set duration_minutes = (transmission.duration_seconds // 60)|int %}
                                                            {% set duration_seconds = (transmission.duration_seconds % 60)|int %}
                                                            <span class="badge bg-info">{{ duration_minutes }}m {{ duration_seconds }}s</span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Back Button -->
                        <div class="text-center mt-4">
                            <a href="{{ url_for('index') }}" class="btn-back">
                                <i class="fas fa-arrow-left me-2"></i>Analizza un altro file
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart for events distribution
        const ctx = document.getElementById('eventsChart').getContext('2d');
        
        // Prepare data for chart - only show main events
        const mainEvents = {
            'CTCSS Detections': {{ stats.events.get('ctcss_detections', 0) }},
            'Squelch Open': {{ stats.events.get('squelch_open', 0) }},
            'Talker Events': {{ stats.events.get('talker_start', 0) + stats.events.get('talker_stop', 0) }},
            'Node Events': {{ stats.events.get('nodes_joined', 0) + stats.events.get('nodes_left', 0) }},
            'Identifications': {{ stats.events.get('identifications', 0) }}
        };

        // Filter out zero values
        const chartLabels = [];
        const chartData = [];
        const chartColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
        const backgroundColors = [];
        
        let colorIndex = 0;
        for (const [label, value] of Object.entries(mainEvents)) {
            if (value > 0) {
                chartLabels.push(label);
                chartData.push(value);
                backgroundColors.push(chartColors[colorIndex % chartColors.length]);
                colorIndex++;
            }
        }

        if (chartData.length > 0) {
            const eventsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        } else {
            // If no data, show a message
            const chartContainer = document.getElementById('eventsChart').parentElement;
            chartContainer.innerHTML = '<p class="text-muted text-center mb-0">Nessun evento significativo rilevato</p>';
        }

        // Chart for TG durations
        {% if stats.talk_groups.tg_durations %}
        const tgCtx = document.getElementById('tgDurationChart').getContext('2d');
        
        // Prepare data for TG duration chart
        const tgLabels = [];
        const tgData = [];
        const tgColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'];
        const tgBackgroundColors = [];
        
        {% for tg, data in stats.talk_groups.tg_durations %}
        tgLabels.push('TG #{{ tg }}');
        tgData.push({{ data.total_seconds }});
        tgBackgroundColors.push(tgColors[{{ loop.index0 }} % tgColors.length]);
        {% endfor %}

        const tgDurationChart = new Chart(tgCtx, {
            type: 'doughnut',
            data: {
                labels: tgLabels,
                datasets: [{
                    label: 'Durata (secondi)',
                    data: tgData,
                    backgroundColor: tgBackgroundColors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const minutes = Math.floor(value / 60);
                                        const seconds = Math.floor(value % 60);
                                        return {
                                            text: `${label} (${minutes}m ${seconds}s)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            strokeStyle: data.datasets[0].borderColor,
                                            lineWidth: data.datasets[0].borderWidth,
                                            pointStyle: 'circle'
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const minutes = Math.floor(value / 60);
                                const seconds = Math.floor(value % 60);
                                return `${context.label}: ${minutes}m ${seconds}s`;
                            }
                        }
                    }
                }
            }
        });
        {% else %}
        // If no TG data, show a message
        const tgChartContainer = document.getElementById('tgDurationChart').parentElement;
        tgChartContainer.innerHTML = '<p class="text-muted text-center mb-0">Nessun Talk Group con QSO rilevato</p>';
        {% endif %}
    </script>
</body>
</html>